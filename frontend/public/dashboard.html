<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .tenant-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .tenant-logo {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        .tenant-details h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .tenant-details .tenant-id {
            color: #666;
            font-size: 14px;
            font-family: monospace;
        }
        
        .settings-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: span 2;
        }
        
        .form-group label {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            grid-column: span 2;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .metric-change {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .metric-change.positive {
            color: #10b981;
        }
        
        .metric-change.negative {
            color: #ef4444;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .chart-container h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }
        
        .chart-canvas {
            position: relative;
            height: 300px;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .chat-viewer {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: none;
        }
        
        .chat-viewer.active {
            display: block;
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .chat-messages {
            max-height: 500px;
            overflow-y: auto;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            background: white;
        }
        
        .chat-message.user {
            background: #e0f2fe;
            margin-left: 20%;
        }
        
        .chat-message.assistant {
            background: white;
            margin-right: 20%;
            border: 1px solid #e5e7eb;
        }
        
        .message-role {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .message-content {
            color: #1f2937;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        .product-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .product-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .product-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .product-card .product-name {
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .product-card .product-vendor {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .product-card .product-price {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
        }
        
        .product-card .product-discount {
            display: inline-block;
            background: #ef4444;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .message-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: #9ca3af;
        }
        
        .session-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .session-row:hover {
            background-color: #f3f4f6;
        }
        
        .session-row.selected {
            background-color: #e0f2fe;
        }
        
        .close-chat {
            padding: 8px 16px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .close-chat:hover {
            background: #4b5563;
        }
        
        .table-container h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #f0f0f0;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f0f0f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .date-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        
        .filter-btn:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }
        
        .success-message {
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-message {
            background: #ef4444;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="tenant-info">
                <div class="tenant-logo" id="tenantLogo">S</div>
                <div class="tenant-details">
                    <h1 id="tenantName">Loading...</h1>
                    <div class="tenant-id" id="tenantId">...</div>
                </div>
            </div>
            
            <div class="success-message" id="successMessage">Settings updated successfully!</div>
            <div class="error-message" id="errorMessage">Failed to update settings</div>
            
            <form class="settings-form" id="settingsForm">
                <div class="form-group">
                    <label for="storeUrl">Store URL</label>
                    <input type="url" id="storeUrl" name="store_url" placeholder="https://example.com">
                </div>
                
                <div class="form-group">
                    <label for="logoUrl">Logo URL</label>
                    <input type="url" id="logoUrl" name="logo_url" placeholder="https://example.com/logo.png">
                </div>
                
                <div class="form-group full-width">
                    <label for="description">Store Description</label>
                    <textarea id="description" name="description" placeholder="Describe your store..."></textarea>
                </div>
                
                <div class="form-group full-width">
                    <label for="brandVoice">Brand Voice</label>
                    <textarea id="brandVoice" name="brand_voice" placeholder="Define your brand's tone and personality..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="aiTemperature">AI Temperature (0-1)</label>
                    <input type="number" id="aiTemperature" name="ai_temperature" min="0" max="1" step="0.1" value="0.7">
                </div>
                
                <div class="form-group">
                    <label for="maxProducts">Max Products Shown</label>
                    <input type="number" id="maxProducts" name="max_products_shown" min="1" max="20" value="5">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </div>
            </form>
        </div>
        
        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card">
                <div class="metric-label">Total Sessions</div>
                <div class="metric-value" id="totalSessions">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Messages Today</div>
                <div class="metric-value" id="messagesToday">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Cost Today</div>
                <div class="metric-value" id="costToday">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Active Sessions</div>
                <div class="metric-value" id="activeSessions">-</div>
            </div>
        </div>
        
        <div class="date-filter">
            <button class="filter-btn active" onclick="changeDateRange(7, this)">7 Days</button>
            <button class="filter-btn" onclick="changeDateRange(30, this)">30 Days</button>
            <button class="filter-btn" onclick="changeDateRange(90, this)">90 Days</button>
        </div>
        
        <div class="charts-grid">
            <div class="chart-container">
                <h3>Sessions Over Time</h3>
                <div class="chart-canvas">
                    <canvas id="sessionsChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Message Volume</h3>
                <div class="chart-canvas">
                    <canvas id="messagesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Cost Breakdown by Model</h3>
                <div class="chart-canvas">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Hourly Activity Pattern</h3>
                <div class="chart-canvas">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <h3>Top Recommended Products</h3>
            <table id="topProductsTable">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Vendor</th>
                        <th>Price Range</th>
                        <th>Recommendations</th>
                    </tr>
                </thead>
                <tbody id="topProductsBody">
                    <tr>
                        <td colspan="4" class="loading">
                            <div class="spinner"></div>
                            Loading products...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="table-container">
            <h3>Recent Sessions (Click to view chat)</h3>
            <table id="recentSessionsTable">
                <thead>
                    <tr>
                        <th>Session ID</th>
                        <th>Started</th>
                        <th>Duration</th>
                        <th>Messages</th>
                        <th>Cost</th>
                    </tr>
                </thead>
                <tbody id="recentSessionsBody">
                    <tr>
                        <td colspan="5" class="loading">
                            <div class="spinner"></div>
                            Loading sessions...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="chat-viewer" id="chatViewer">
            <div class="chat-header">
                <h3>Chat Session: <span id="chatSessionId"></span></h3>
                <button class="close-chat" onclick="closeChatViewer()">Close</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be loaded here -->
            </div>
        </div>
    </div>
    
    <script>
        // Get tenant ID from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const tenantId = urlParams.get('tenant_id') || '6b028cbb-512d-4538-a3b1-71bc40f49ed1';
        let currentDays = 7;
        
        // Chart instances
        let sessionsChart, messagesChart, costChart, hourlyChart;
        
        // Initialize dashboard
        async function initDashboard() {
            await loadTenantInfo();
            await loadOverviewMetrics();
            await loadCharts();
            await loadTopProducts();
            await loadRecentSessions();
        }
        
        // Load tenant info and settings
        async function loadTenantInfo() {
            try {
                const response = await fetch(`/api/dashboard/${tenantId}/info`);
                const data = await response.json();
                
                document.getElementById('tenantName').textContent = data.name;
                document.getElementById('tenantId').textContent = data.tenant_id;
                document.getElementById('tenantLogo').textContent = data.name.charAt(0).toUpperCase();
                
                // Populate form fields
                document.getElementById('storeUrl').value = data.store_url || '';
                document.getElementById('logoUrl').value = data.logo_url || '';
                document.getElementById('description').value = data.description || '';
                document.getElementById('brandVoice').value = data.brand_voice || '';
                document.getElementById('aiTemperature').value = data.settings?.ai_temperature || 0.7;
                document.getElementById('maxProducts').value = data.settings?.max_products_shown || 5;
            } catch (error) {
                console.error('Failed to load tenant info:', error);
            }
        }
        
        // Load overview metrics
        async function loadOverviewMetrics() {
            try {
                const response = await fetch(`/api/dashboard/${tenantId}/overview`);
                const data = await response.json();
                
                document.getElementById('totalSessions').textContent = data.total_sessions || 0;
                document.getElementById('messagesToday').textContent = data.messages_today || 0;
                document.getElementById('costToday').textContent = '$' + (data.cost_today || 0).toFixed(2);
                document.getElementById('activeSessions').textContent = data.active_sessions || 0;
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }
        
        // Load all charts
        async function loadCharts() {
            await loadSessionsChart();
            await loadMessagesChart();
            await loadCostChart();
            await loadHourlyChart();
        }
        
        // Load sessions over time chart
        async function loadSessionsChart() {
            try {
                const response = await fetch(`/api/dashboard/${tenantId}/sessions?days=${currentDays}`);
                const data = await response.json();
                
                const ctx = document.getElementById('sessionsChart').getContext('2d');
                
                if (sessionsChart) sessionsChart.destroy();
                
                sessionsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => new Date(d.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Sessions',
                            data: data.map(d => d.session_count),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load sessions chart:', error);
            }
        }
        
        // Load messages volume chart
        async function loadMessagesChart() {
            try {
                const response = await fetch(`/api/dashboard/${tenantId}/messages?days=${currentDays}`);
                const data = await response.json();
                
                const ctx = document.getElementById('messagesChart').getContext('2d');
                
                if (messagesChart) messagesChart.destroy();
                
                messagesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => new Date(d.date).toLocaleDateString()),
                        datasets: [
                            {
                                label: 'User Messages',
                                data: data.map(d => d.user_messages),
                                backgroundColor: '#667eea'
                            },
                            {
                                label: 'Assistant Messages',
                                data: data.map(d => d.assistant_messages),
                                backgroundColor: '#764ba2'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load messages chart:', error);
            }
        }
        
        // Load cost breakdown chart
        async function loadCostChart() {
            try {
                const response = await fetch(`/api/dashboard/${tenantId}/costs?days=${currentDays}`);
                const data = await response.json();
                
                const ctx = document.getElementById('costChart').getContext('2d');
                
                if (costChart) costChart.destroy();
                
                costChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.models.map(m => m.model),
                        datasets: [{
                            data: data.models.map(m => m.cost),
                            backgroundColor: [
                                '#667eea',
                                '#764ba2',
                                '#10b981',
                                '#f59e0b',
                                '#ef4444'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': $' + context.parsed.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load cost chart:', error);
            }
        }
        
        // Load hourly activity chart
        async function loadHourlyChart() {
            try {
                const response = await fetch(`/api/dashboard/${tenantId}/activity/hourly`);
                const data = await response.json();
                
                const ctx = document.getElementById('hourlyChart').getContext('2d');
                
                if (hourlyChart) hourlyChart.destroy();
                
                hourlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.hour + ':00'),
                        datasets: [{
                            label: 'Messages',
                            data: data.map(d => d.message_count),
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load hourly chart:', error);
            }
        }
        
        // Load top products
        async function loadTopProducts() {
            try {
                const response = await fetch(`/api/dashboard/${tenantId}/products/top?days=${currentDays}`);
                const data = await response.json();
                
                const tbody = document.getElementById('topProductsBody');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No product data available</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(product => `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.vendor || '-'}</td>
                        <td>$${product.price_min.toFixed(2)} - $${product.price_max.toFixed(2)}</td>
                        <td>${product.event_count}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load top products:', error);
                document.getElementById('topProductsBody').innerHTML = '<tr><td colspan="4" style="text-align: center;">Failed to load products</td></tr>';
            }
        }
        
        // Load recent sessions
        async function loadRecentSessions() {
            try {
                const response = await fetch(`/api/dashboard/${tenantId}/sessions/recent`);
                const data = await response.json();
                
                const tbody = document.getElementById('recentSessionsBody');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No sessions found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(session => `
                    <tr class="session-row" onclick="loadSessionChat('${session.session_id}')">
                        <td style="font-family: monospace; font-size: 12px;">${session.session_id.substring(0, 8)}...</td>
                        <td>${new Date(session.started_at).toLocaleString()}</td>
                        <td>${session.duration_minutes ? Math.round(session.duration_minutes) + ' min' : '-'}</td>
                        <td>${session.message_count || 0}</td>
                        <td>$${(session.estimated_cost || 0).toFixed(4)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load recent sessions:', error);
                document.getElementById('recentSessionsBody').innerHTML = '<tr><td colspan="5" style="text-align: center;">Failed to load sessions</td></tr>';
            }
        }
        
        // Change date range
        function changeDateRange(days, button) {
            currentDays = days;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Reload charts and tables
            loadCharts();
            loadTopProducts();
        }
        
        // Handle settings form submission
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const settings = {};
            
            // Build settings object
            for (let [key, value] of formData.entries()) {
                if (value !== '') {
                    settings[key] = value;
                }
            }
            
            try {
                const response = await fetch(`/api/dashboard/${tenantId}/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    document.getElementById('successMessage').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('successMessage').style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error('Failed to update settings');
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('errorMessage').style.display = 'none';
                }, 3000);
            }
        });
        
        // Reset form
        function resetForm() {
            loadTenantInfo();
        }
        
        // Load chat messages for a session
        async function loadSessionChat(sessionId) {
            try {
                // Update UI to show selected session
                document.querySelectorAll('.session-row').forEach(row => {
                    row.classList.remove('selected');
                });
                event.currentTarget.classList.add('selected');
                
                // Show chat viewer
                const chatViewer = document.getElementById('chatViewer');
                chatViewer.classList.add('active');
                document.getElementById('chatSessionId').textContent = sessionId.substring(0, 8) + '...';
                
                // Load messages
                const response = await fetch(`/api/dashboard/${tenantId}/sessions/${sessionId}/messages`);
                const messages = await response.json();
                
                const chatMessages = document.getElementById('chatMessages');
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = '<div style="text-align: center; color: #6b7280;">No messages in this session</div>';
                    return;
                }
                
                chatMessages.innerHTML = messages.map(msg => {
                    let messageHtml = `
                        <div class="chat-message ${msg.role}">
                            <div class="message-role">${msg.role.toUpperCase()}</div>
                            <div class="message-content">${escapeHtml(msg.content)}</div>
                    `;
                    
                    // If there's structured data with products, render product cards
                    if (msg.structured_data && msg.structured_data.products) {
                        messageHtml += '<div class="product-cards-container">';
                        msg.structured_data.products.forEach(product => {
                            messageHtml += `
                                <div class="product-card">
                                    ${product.image_url ? `<img src="${product.image_url}" alt="${escapeHtml(product.name)}">` : ''}
                                    <div class="product-name" title="${escapeHtml(product.name)}">${escapeHtml(product.name)}</div>
                                    <div class="product-vendor">${escapeHtml(product.vendor || 'Unknown')}</div>
                                    <div>
                                        <span class="product-price">$${product.price_min.toFixed(2)}</span>
                                        ${product.has_discount ? '<span class="product-discount">SALE</span>' : ''}
                                    </div>
                                </div>
                            `;
                        });
                        messageHtml += '</div>';
                    }
                    
                    messageHtml += `
                            <div class="message-meta">
                                <span>${msg.model_used || 'N/A'}</span>
                                <span>${msg.cost ? '$' + msg.cost.toFixed(6) : ''}</span>
                                <span>${new Date(msg.created_at).toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                    
                    return messageHtml;
                }).join('');
                
                // Scroll to top of messages
                chatMessages.scrollTop = 0;
                
            } catch (error) {
                console.error('Failed to load chat messages:', error);
                alert('Failed to load chat messages');
            }
        }
        
        // Close chat viewer
        function closeChatViewer() {
            document.getElementById('chatViewer').classList.remove('active');
            document.querySelectorAll('.session-row').forEach(row => {
                row.classList.remove('selected');
            });
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize on load
        initDashboard();
        
        // Refresh data every 30 seconds
        setInterval(() => {
            loadOverviewMetrics();
            loadRecentSessions();
        }, 30000);
    </script>
</body>
</html>